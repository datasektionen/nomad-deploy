name: "Deploy Job to Nomad"
author: "Konglig Datasektionen"
description: "Deploys an application to Datasektionen's Nomad environment."
inputs:
  token:
    description: "Nomad Deploy token authorized to issue this deployment"
    required: true
  job-file-path:
    description: "Path to file containing Nomad job spec for this application"
    default: "job.nomad.hcl"
  image-tag:
    description: "The ghcr.io tag to release under (e.g., latest or preview)"
    default: "latest"
  nomad-version:
    description: "Hashicorp Nomad version to download and use (leave default)"
    default: "1.7.7"
runs:
  using: "composite"
  steps:
    - name: Git checkout
      uses: actions/checkout@v4

    - name: Set environment variables
      run: |
        cat >> "$GITHUB_ENV" <<EOF
        pkg="ghcr.io/${{ github.repository}}"
        rev="$pkg:$(git rev-parse --short ${{ github.sha }})"
        release="$pkg:{{ inputs.image-tag }}"
        EOF

    - name: Download Nomad
      env:
        NOMAD_VERSION: ${{ inputs.nomad-version }}
      run: |
        curl -LO https://releases.hashicorp.com/nomad/${{ env.NOMAD_VERSION }}/nomad_${{ env.NOMAD_VERSION }}_linux_amd64.zip
        unzip -d /usr/local/bin nomad_${{ env.NOMAD_VERSION }}_linux_amd64.zip nomad

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log into ghcr.io
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and Push
      uses: docker/build-push-action@v5
      with:
        push: true
        tags: ${{ env.rev }},${{ env.release }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Deploy to Nomad
      env:
        NOMAD_ADDR: ${{ vars.NOMAD_ADDR }} # org-level variable
        NOMAD_TOKEN: ${{ inputs.token }}
      run: |
        nomad run -var=image_tag=${{ env.rev }} ${{ inputs.job-file-path }}
